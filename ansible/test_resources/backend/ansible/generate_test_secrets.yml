---
- name: Generate test secrets.yaml.encrypted
  hosts: localhost
  connection: local
  tasks:
    - name: Create secrets.yaml.encrypted
      ansible.builtin.shell: |
        python3 -c "
        from cryptography.fernet import Fernet
        import base64
        import yaml
        import os

        secret_key = os.environ.get('SECRET_KEY', 'default-test-secret-key').ljust(32)[:32].encode('utf-8')
        db_password = os.environ.get('DB_PASSWORD', 'default-test-db-password').encode('utf-8')
        
        key_base64 = base64.urlsafe_b64encode(secret_key)
        fernet = Fernet(key_base64)
        encrypted_pw = fernet.encrypt(db_password).decode('utf-8')
        
        secrets_data = {
            'database': {
                'password': f'ENC({encrypted_pw})'
            }
        }
        
        with open('config/secrets.yaml.encrypted', 'w') as f:
            yaml.dump(secrets_data, f)
        "
      args:
        chdir: . # カレントディレクトリで実行
