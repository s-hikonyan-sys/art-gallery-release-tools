---
- name: Ensure database scripts directory exists  
  ansible.builtin.file:    
    path: "{{ deployment_paths.deployment_dir }}/scripts"    
    state: directory    
    mode: '0755'    
    owner: "{{ app_user }}"    
    group: "{{ app_user }}"
  tags:    
    - deploy-database-code

- name: Ensure database config directory exists
  ansible.builtin.file:
    path: "{{ deployment_paths.conf_dir }}/database/config"
    state: directory
    mode: '0700'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags: [deploy-database-code]
  
- name: Deploy postgres-entrypoint.sh and migrations from GitHub  
  ansible.builtin.git:    
    repo: "https://{{ github_token_database }}@github.com/{{ github_owner }}/{{ service_repo_names.postgres }}.git"    
    dest: "{{ deployment_paths.src_dir }}/{{ service_repo_names.postgres }}"    
    version: "{{ database_ref | mandatory('database_ref must be provided') }}"    
    force: yes  
  become: yes  
  tags:    
    - deploy-database-code

- name: Copy postgres-entrypoint.sh to deployment directory  
  ansible.builtin.copy:    
    src: "{{ deployment_paths.src_dir }}/{{ service_repo_names.postgres }}/scripts/postgres-entrypoint.sh"    
    dest: "{{ deployment_paths.deployment_dir }}/scripts/postgres-entrypoint.sh"    
    mode: '0755'    
    owner: "{{ app_user }}"    
    group: "{{ app_user }}"    
    remote_src: yes  
  tags:    
    - deploy-database-code
