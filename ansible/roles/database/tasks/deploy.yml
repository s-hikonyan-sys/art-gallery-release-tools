---
- name: Ensure database scripts directory exists  
  ansible.builtin.file:    
    path: "{{ deployment_paths.deployment_dir }}/scripts"    
    state: directory    
    mode: '0755'    
    owner: "{{ app_user }}"    
    group: "{{ app_user }}"
  tags:    
    - deploy-database-code

- name: Ensure database config directory exists
  ansible.builtin.file:
    path: "{{ deployment_paths.conf_dir }}/database/config"
    state: directory
    mode: '0700'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags: [deploy-database-code]
  
- name: Deploy postgres-entrypoint.sh and migrations from GitHub
  # git -c によるインメモリ認証設定を使用。.git/config へのトークン書き込みを防ぐ
  ansible.builtin.shell: |
    set -e
    DEST="{{ deployment_paths.src_dir }}/{{ service_repo_names.postgres }}"
    REPO_URL="https://github.com/{{ github_owner }}/{{ service_repo_names.postgres }}.git"
    TOKEN_REWRITE="url.https://x-access-token:{{ github_token_database }}@github.com/.insteadOf=https://github.com/"

    if [ -d "${DEST}/.git" ]; then
      git -C "${DEST}" -c "${TOKEN_REWRITE}" fetch --depth 1 origin "{{ database_ref | mandatory('database_ref must be provided') }}"
      git -C "${DEST}" reset --hard FETCH_HEAD
    else
      git -c "${TOKEN_REWRITE}" clone --depth 1 --branch "{{ database_ref | mandatory('database_ref must be provided') }}" \
        "${REPO_URL}" "${DEST}"
    fi
  no_log: true
  become: yes
  become_user: "{{ app_user }}"
  tags:
    - deploy-database-code

- name: Copy postgres-entrypoint.sh to deployment directory  
  ansible.builtin.copy:    
    src: "{{ deployment_paths.src_dir }}/{{ service_repo_names.postgres }}/scripts/postgres-entrypoint.sh"    
    dest: "{{ deployment_paths.deployment_dir }}/scripts/postgres-entrypoint.sh"    
    mode: '0755'    
    owner: "{{ app_user }}"    
    group: "{{ app_user }}"    
    remote_src: yes  
  tags:    
    - deploy-database-code
