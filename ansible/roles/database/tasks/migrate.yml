---
- name: Ensure migration history table exists
  community.docker.docker_container_exec:
    container: art-gallery-db
    command: psql -h localhost -U {{ database_user }} -d {{ database_name }} -W
    stdin: |
      {{ db_password }}
      CREATE TABLE IF NOT EXISTS schema_migrations (
          version VARCHAR(255) PRIMARY KEY,
          applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
      );
    user: postgres
  register: result
  until: result is success
  retries: 10
  delay: 5
  no_log: true
  tags: [database-migration]

- name: Get applied migrations
  community.docker.docker_container_exec:
    container: art-gallery-db
    command: psql -h localhost -U {{ database_user }} -d {{ database_name }} -W -t -A -c "SELECT version FROM schema_migrations;"
    stdin: "{{ db_password }}"
    user: postgres
  register: applied_migrations_raw
  no_log: true
  tags: [database-migration]

- name: Find migration files
  ansible.builtin.find:
    paths: "{{ database_migration.migrations_base_path }}/v{{ database_migration.target_version }}"
    patterns: "*.sql"
  register: migration_files
  delegate_to: localhost
  tags: [database-migration]

- name: Apply pending migrations
  community.docker.docker_container_exec:
    container: art-gallery-db
    command: psql -h localhost -U {{ database_user }} -d {{ database_name }} -W
    stdin: |
      {{ db_password }}
      {{ lookup('file', item.path) }}
      INSERT INTO schema_migrations (version) VALUES ('{{ item.path | basename | replace('.sql', '') }}') ON CONFLICT DO NOTHING;
    user: postgres
  loop: "{{ migration_files.files | sort(attribute='path') }}"
  when: item.path | basename | replace('.sql', '') not in applied_migrations_raw.stdout_lines
  no_log: true
  tags: [database-migration]
