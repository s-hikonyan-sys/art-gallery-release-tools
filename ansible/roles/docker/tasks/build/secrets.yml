---
# Secrets APIコンテナイメージのビルド
# 準備 → ビルド → 後処理の順で実行

# === 準備 ===
- name: Create temporary build directory for secrets
  ansible.builtin.tempfile:
    state: directory
    suffix: secrets-build
  register: secrets_build_dir
  tags:
    - docker
    - build-all
    - build
    - build-secrets

- name: Ensure internal directory exists in temporary build directory
  ansible.builtin.file:
    path: "{{ secrets_build_dir.path }}/internal"
    state: directory
    mode: '0755'
  tags:
    - docker
    - build-all
    - build
    - build-secrets

- name: Copy secrets Dockerfile to temporary directory
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/roles/secrets/internal/Dockerfile"
    dest: "{{ secrets_build_dir.path }}/Dockerfile"
    mode: '0644'
  tags:
    - docker
    - build-all
    - build
    - build-secrets

- name: Copy requirements.txt to internal directory for Docker build cache
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/roles/secrets/internal/requirements.txt"
    dest: "{{ secrets_build_dir.path }}/internal/requirements.txt"
    mode: '0644'
  tags:
    - docker
    - build-all
    - build
    - build-secrets

# === ビルド ===
- name: Build secrets container image
  community.docker.docker_image:
    name: "{{ image_names.secrets | mandatory('image_names.secrets must be set in inventory') }}"
    tag: "{{ secrets_version | mandatory('secrets_version must be provided via extra-vars or a variable source') }}"
    build:
      path: "{{ secrets_build_dir.path }}"
      dockerfile: Dockerfile
      pull: yes
    source: build
    state: present
  tags:
    - docker
    - build-all
    - build
    - build-secrets

# === 後処理 ===
- name: Remove temporary build directory for secrets
  ansible.builtin.file:
    path: "{{ secrets_build_dir.path }}"
    state: absent
  tags:
    - docker
    - build-all
    - build
    - build-secrets
