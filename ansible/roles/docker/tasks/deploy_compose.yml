---
# docker-compose.ymlのデプロイ
# 環境に応じたテンプレートを使用して生成します

# Vault変数の読み込み（secrets_vault_file_path は pre_tasks で設定済み）
- name: Load vault variables for docker-compose
  ansible.builtin.include_vars:
    file: "{{ secrets_vault_file_path }}"
  tags:
    - docker
    - deploy-compose
    - deploy-all

- name: Deploy docker-compose.yml from template
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ deployment_paths.deployment_dir }}/docker-compose.yml"
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    mode: '0600'
  tags:
    - docker
    - deploy-compose
    - deploy-all