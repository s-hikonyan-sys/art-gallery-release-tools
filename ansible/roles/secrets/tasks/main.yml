---
# secrets-api用ファイルのコピー（暗号化・復号化処理は一切行わない）

- name: Create secrets-api config directory
  ansible.builtin.file:
    path: "{{ deployment_paths.conf_dir }}/secrets/config"
    state: directory
    mode: '0755'
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
  tags:
    - secrets
    - deploy
    - deploy-all

- name: Copy secrets.yaml.encrypted to remote server for secrets-api
  ansible.builtin.copy:
    src: "{{ secrets_yaml_encrypted_path }}"
    dest: "{{ deployment_paths.conf_dir }}/secrets/config/secrets.yaml.encrypted"
    mode: '0600'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags:
    - secrets
    - deploy
    - deploy-all

- name: Copy config.yaml to remote server for secrets-api
  ansible.builtin.copy:
    src: "{{ config_yaml_path }}"
    dest: "{{ deployment_paths.conf_dir }}/secrets/config/config.yaml"
    mode: '0644'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags:
    - secrets
    - deploy
    - deploy-all

- name: Create secrets-api tokens directory
  ansible.builtin.file:
    path: "{{ deployment_paths.conf_dir }}/secrets/tokens"
    state: directory
    mode: '0700'
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
  tags:
    - secrets
    - deploy
    - deploy-all
