---
- name: Load vault variables for secrets-api
  ansible.builtin.include_vars:
    file: "{{ secrets_vault_file_path }}"
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Read secret_key from vault for secrets-api
  ansible.builtin.shell: |
    ansible-vault decrypt --output - --vault-password-file {{ playbook_dir }}/.vault_pass "{{ secrets_vault_file_path }}" | python3 -c "\
    import sys, yaml\
    data = yaml.safe_load(sys.stdin) or {}\
    print(data.get('secret_key', ''))"
  register: secrets_api_secret_key_result
  changed_when: false
  delegate_to: localhost
  run_once: true
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Set secret_key fact for secrets-api
  ansible.builtin.set_fact:
    secrets_api_secret_key: "{{ secrets_api_secret_key_result.stdout | trim }}"
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Ensure secrets-api directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
  loop:
    - { path: "{{ deployment_paths.conf_dir }}/secrets/config", mode: '0755' }
    - { path: "{{ deployment_paths.conf_dir }}/secrets/tokens", mode: '0700' }
    - { path: "{{ deployment_paths.logs_dir }}/secrets", mode: '0755' }
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Generate and copy encrypted secrets
  ansible.builtin.shell: |
    python3 {{ playbook_dir }}/scripts/encrypt_secrets.py \
      "{{ secrets_vault_file_path }}" \
      "{{ secrets_api_secret_key }}" \
      "/tmp/secrets.yaml.encrypted"
  changed_when: true
  delegate_to: localhost
  become: no
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Copy secrets.yaml.encrypted to remote server for secrets-api
  ansible.builtin.copy:
    src: "/tmp/secrets.yaml.encrypted"
    dest: "{{ deployment_paths.conf_dir }}/secrets/config/secrets.yaml.encrypted"
    mode: '0600'
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Deploy config.yaml for secrets-api
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ deployment_paths.conf_dir }}/secrets/config/config.yaml"
    mode: '0644'
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
  tags: [secrets, deploy, deploy-secrets, deploy-all]

- name: Deploy secrets-api application code from GitHub
  ansible.builtin.git:
    repo: "https://{{ github_token_secrets }}@github.com/{{ github_owner }}/{{ service_repo_names.secrets }}.git"
    dest: "{{ deployment_paths.src_dir }}/{{ service_repo_names.secrets }}"
    version: "{{ secrets_ref | mandatory('secrets_ref must be provided') }}"
    force: yes
  become: yes
  tags: [secrets, deploy-secrets, deploy-all]
