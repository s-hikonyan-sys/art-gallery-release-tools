---
# バックエンドデプロイ関連処理
# 設定ファイル生成など

- name: Ensure backend logs directory exists
  ansible.builtin.file:
    path: "{{ deployment_paths.logs_dir }}/backend"
    state: directory
    mode: '0755'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags:
    - backend
    - deploy
    - deploy-backend
    - deploy-all

- name: Ensure backend config directory exists
  ansible.builtin.file:
    path: "{{ deployment_paths.conf_dir }}/backend/config"
    state: directory
    mode: '0700'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags:
    - backend
    - deploy
    - deploy-backend
    - deploy-all

- name: Create config.yaml from template
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ deployment_paths.conf_dir }}/backend/config/config.yaml"
    mode: '0600'
    owner: "{{ app_user | mandatory('app_user must be set in inventory') }}"
    group: "{{ app_user | mandatory('app_user must be set in inventory') }}"
  tags:
    - backend
    - deploy
    - deploy-backend
    - deploy-all

- name: Deploy backend application code from GitHub
  # git -c によるインメモリ認証設定を使用。.git/config へのトークン書き込みを防ぐ
  ansible.builtin.shell: |
    set -e
    DEST="{{ deployment_paths.src_dir }}/{{ service_repo_names.backend }}"
    REPO_URL="https://github.com/{{ github_owner }}/{{ service_repo_names.backend }}.git"
    TOKEN_REWRITE="url.https://x-access-token:{{ github_token_backend }}@github.com/.insteadOf=https://github.com/"

    if [ -d "${DEST}/.git" ]; then
      git -C "${DEST}" -c "${TOKEN_REWRITE}" fetch --depth 1 origin "{{ backend_ref | mandatory('backend_ref must be provided') }}"
      git -C "${DEST}" reset --hard FETCH_HEAD
    else
      git -c "${TOKEN_REWRITE}" clone --depth 1 --branch "{{ backend_ref | mandatory('backend_ref must be provided') }}" \
        "${REPO_URL}" "${DEST}"
    fi
  no_log: true
  become: yes
  become_user: "{{ app_user }}"
  tags:
    - backend
    - deploy-backend
    - deploy-all