---
# デプロイプレイブック
# サーバーへの実装反映、設定更新、コンテナ起動を実行します
# 実装物（app.py等）はボリュームマウントで提供され、イメージには含まれません

- name: Deploy Application to Environment
  hosts: "{{ target_hosts }}"
  become: "{{ ansible_become | mandatory('ansible_become must be set in inventory') }}"

  pre_tasks:
    - name: Setup vault configuration
      ansible.builtin.import_tasks: tasks/setup-vault.yml
      tags: [always]

  tasks:
    - name: Deploy docker-compose.yml
      ansible.builtin.include_role:
        name: docker
        tasks_from: deploy_compose
      tags:
        - docker
        - deploy-compose
        - deploy-all

    - name: Deploy database entrypoint configuration
      ansible.builtin.include_role:
        name: database-entrypoint
      tags:
        - database-entrypoint
        - deploy
        - deploy-all

    # Cleanup と DB マイグレーションをアプリケーションデプロイ前に移動
    - name: Cleanup irregular cases (containers)
      ansible.builtin.include_role:
        name: docker-cleanup
        tasks_from: irregular
      tags:
        - cleanup
        - cleanup-irregular

    - name: Run database initialization (first-time setup)
      ansible.builtin.include_role:
        name: database-init
      tags:
        - database-init

    - name: Run database migrations (version upgrades)
      ansible.builtin.include_role:
        name: database-migration
      tags:
        - database-migration

    - name: Deploy backend (source and config)
      ansible.builtin.include_role:
        name: backend
      tags:
        - deploy-backend
        - deploy-all

    - name: Deploy frontend (directory setup)
      ansible.builtin.include_role:
        name: frontend
        tasks_from: deploy
      tags:
        - deploy-frontend
        - deploy-all

    - name: Deploy nginx (config and entrypoint)
      ansible.builtin.include_role:
        name: nginx
      tags:
        - deploy-nginx
        - deploy-all

    # アプリケーションのデプロイ後にコンテナを起動
    - name: Start all containers
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/start/start_all
      tags:
        - docker
        - start-all
        - deploy-all

    - name: Start backend container only
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/start/start_backend
      tags:
        - docker
        - start-app

    # コンテナイメージの更新と再作成（pull: always, recreate: always）
    # これらのタスクは production_deploy.yml からタグ指定で呼び出される
    - name: Update all containers with latest images
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/update/update_all
      tags:
        - docker
        - update-all

    - name: Update postgres container only (pull and restart)
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/update/update_db_image
      tags:
        - docker
        - update-db-image

    - name: Update backend container only (pull and restart)
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/update/update_backend_image
      tags:
        - docker
        - update-backend-image

    - name: Update nginx container only (pull and restart)
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/update/update_nginx_image
      tags:
        - docker
        - update-nginx-image

    # Backend/Nginx の設定更新に伴う再起動/リロード
    # これらのタスクは production_deploy.yml からタグ指定で呼び出される
    - name: Restart backend container only
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/restart/restart_backend
      tags:
        - docker
        - restart-backend

    - name: Reload nginx after frontend build
      ansible.builtin.include_role:
        name: docker-exec
        tasks_from: nginx/reload
      tags:
        - frontend
        - reload-nginx
        - restart-frontend

    - name: Restart nginx container only
      ansible.builtin.include_role:
        name: docker
        tasks_from: container/restart/restart_nginx
      tags:
        - docker
        - restart-nginx
