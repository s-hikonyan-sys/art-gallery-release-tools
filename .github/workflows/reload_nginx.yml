name: Reload Nginx

# nginx -s reload のみを実行する軽量ワークフロー
# nginx.conf の変更は行わない（git pull なし）
# 用途:
#   - frontend デプロイ後の手動リロード再試行
#   - nginx コンテナの動作確認
#   - deploy_frontend.yml が失敗した際のリカバリ

on:
  workflow_dispatch:

jobs:
  reload:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout art-gallery-release-tools repository
        uses: actions/checkout@v4

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Setup SSH for Production Deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/ansible_deploy_key
          chmod 600 ~/.ssh/ansible_deploy_key
          echo "${{ secrets.PROD_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Write Ansible extra-vars file
        run: |
          cat > /tmp/ansible_vars.json << 'VARS_EOF'
          {
            "target_hosts": "production",
            "prod_host": "${{ vars.PROD_HOST }}",
            "prod_ssh_user": "${{ vars.PROD_SSH_USER }}",
            "prod_ssh_key_path": "~/.ssh/ansible_deploy_key"
          }
          VARS_EOF
          chmod 600 /tmp/ansible_vars.json

      - name: Reload Nginx
        run: |
          cd ansible
          ansible-playbook playbook_reload_nginx.yml \
            --inventory inventory/production.yml \
            --extra-vars "@/tmp/ansible_vars.json" \
            --tags "reload-nginx"

      - name: Remove extra-vars file
        if: always()
        run: rm -f /tmp/ansible_vars.json
